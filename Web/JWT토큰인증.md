# JWT 토큰인증

로그인 기능을 구현하는중 서버가 클라이언트 인증을 어떤 방식으로 확인 하는지 알기위해 정리한다.

## Cookie / Session / Token 인증방식

JWT 토큰 인증 방식을 배우기 앞서 쿠키, 세션, 토큰 방식의 통신방식의 특징과 장단점을 간단하게 알아보고, 왜 토큰 인증 방식을 사용하는지 알아보자.

## Cookie 인증

쿠키는 key-value 형식의 문자이다.

클라이언트가 웹사이트 방문시 그 사이트가 사용하고 있는 서버를 통해 클라이언트 브라우저에 설치되는 작은 정보 기록 파일이다.

각 사용자마다 브라우저에 정보를 저장하니 정보 식별이 가능하다.

## Cookie 인증방식

1. 브라우저가 POST 방식으로 서버에 로그인 요청
2. 로그인 정보가 일치하면 서버는 set-Cookie를 통해 쿠키를 만들어서 브라우저에 전달
3. 이후 브라우저가 요청을 보낼때 마다 요청 헤더의 Cookie에 담아 보냄

## Cookie 장단점

### 장점

- 쿠키를 이용하면 세션 유지 가능
- 로그인정보가 일치하고 쿠키가 발급되면 서버에 재요청시 클라이언트 식별 가능

### 단점

- 클라이언트가 요청시 쿠키 값을 그대로 전달하기 때문에 보안에 취약함
- 쿠키에는 용량제한이 있어 많은정보를 담을수 없음

<!-- > 세션(Session)이란<br/>클라이언트와 서버간의 상태를 유지하고 관리하는것을 의미함 -->
<br />
<br />

## Session 인증

#### 세션이란 클라이언트와 서버간의 상태를 유지하고 관리하는 것을 의미함

세션 인증 방식은 쿠키처럼 브라우저에 인증정보를 저장하는 것이 아닌 서버에서 저장하고 관리 한다. 서버의 메모리에 저장 or 서버로컬파일 or 데이터베이스에 저장.

세션 객체는 Key에 해당하는 세션ID와 Value로 구성됨.

Value의 구성은 세션생성시간, 마지막 접근시간, 클라이언트가 저장한 속성등이 Map 형태로 저장됨.

## Session 인증방식

1. 클라이언트가 브라우저에서 로그인
2. 로그인 정보가 일치하면 서버메모리(데이터베이스)에 세션ID와 Value 저장
3. 브라우저의 쿠키에 세션ID 저장
4. 이후 브라우저가 서버에 요청 할때 세션ID와 함께 전송
5. 서버에 저장된 세션ID와 브라우저가 요청할때 전송한 세션ID와 비교해 인증

## Session 장단점

### 장점

- 보안정보를 직접적으로 관리하기 때문에 쿠키보단 안전

### 단점

- 해커가 세션ID를 탈취해 클라이언트인척 위장을 할수 있음
- 서버에 세션 저장소를 이용하기 떄문에 서버 부하가 심해짐

<br />
<br />

## Token 인증

토큰 기반 인증 방식은 클라이언트가 서버에 로그인을 시도해 정보가 일치하면 클라이언트에게 토큰을 부여함.

토큰은 유일한 값이고 서버에 재요청을 할때 요청헤더에 포함시켜 전달함.

<!-- ?? 세션도 재요청시 요청헤더에 포함해서 전달하는거아님? 똑같네? 쿠키도  -->

기존 세션기반 인증방식은 서버에서 세션ID를 통해 클라이언트를 식별하기 때문에 서버에 오버헤드가 발생함.

하지만 토큰은 클라이언트에 저장되기 때문에 서버메모리, 데이터베이스를 통해 세션을 관리했던 부담을 줄여줌.

토큰자체에 데이터가 들어가 있기때문에 위조되었는지만 판별하면 됨.

### 서버(세션) 기반 vs 토큰 기반

#### 서버(세션)기반 인증시스템

서버 기반 인증 시스템은 서버(메모리, 데이터베이스) 에서 사용자 인증을 관리하는 것을 의미함.

클라이언트 요청을 받으면 클라이언트 상태를 유지 해놓고 사용함.
Stateful은 사용자가 증가하면 성능에 문제를 일으킬수 있기 때문에 확장성이 어려운 단점을 지님.

#### 토큰 기반 인증시스템

서버기반 인증시스템의 단점을 보완하고자 토큰인증 시스템이 생김.

인증받은 사용자에게 토큰을 발급하고 사용자가 서버에 요청시 요청헤더에 토큰을 담아 식별함.

토큰은 서버 기반 인증시스템과 반대로 상태를 유지하지 않아 Stateless한 특징을 지님
즉, 토큰에는 만료시간이 존재하기 때문에 만료되면 사용할수 없음.

## Token 인증방식

1. 클라이언트가 브라우저에서 로그인
2. 로그인 정보가 일치하면 클라이언트에게 토큰 발급
3. 토큰은 쿠키나 스토리지에 저장하고, 서버 요청시 요청헤더에 토큰을 포함 시켜 전달.
4. 서버는 전달받은 토큰을 검증하고 응답.

## Token 장단점

### 장점

- 서버의 오버헤드를 줄여줌

### 단점

- 쿠키/세션과 다르게 데이터의 길이가 길어 인증 요청이 많을수록 부하가 심해짐
- Payload 자체는 암호화가 되지 않아 중요한 정보는 담을수 없음
- 토큰을 탈취 당하면 대처하기 어려움 (그래서 토큰의 만료시간이 존재함)

<br />
<br />

## JWT (Json Web Token)이란

JWT는 인증에 필요한 정보들을 암호화 시킨 JSON 토큰을 의미한다.

JWT 기반 인증은 HTTP 헤더에 넣어 서버가 클라이언트를 식별하는 방식이다.

JWT는 JSON 데이터를 Base64-URL-safe Encode를 통해 인코딩하여 직렬화 한것이고, 토큰 내부에는 위변조 방지를 위해 개인 서명도 들어가 있음.

따라서 JWT를 서버로 전송하면 서버는 서명을 검증하는 과정을 거침.

## JWT 구조

JWT는 HEADR, 내용(Payload), 서명(Signature)로 구성.

```js
{   // HEADER
    "alg" : "HS256", // 알고리즘
    "typ" : "JWT"    // 종류
}

{   // Payload 클레임(사용자정보)
  "sub": "1234567890",
  "name": "John Doe",
  "iat": 1516239022
}

HMACSHA256( // Signature   HEADER + Payload + key
  base64UrlEncode(header) + "." +
  base64UrlEncode(payload),
  your-256-bit-secret
)

```

## JWT 인증과정

1. 클라이언트가 브라우저에서 로그인
2. 로그인 정보가 일치하면 Header, Payload, Signature 정의 Base64 인코딩 후 JWT 생성
3. 서버로 부터받은 JWT를 쿠키에 저장 (로컬 스토리지나 다른데 저장도 가능)
4. API 서버에 요청시 Authorization headr에 Access Token을 담아서 보냄
5. JWT 토큰이 서버내에서 발행한 토큰인지 일치여부 확인
6. Access Token 만료시 서버로부터 Refresh Token을 통해 재발급

## JWT 장단점

### 장점

- HEADER + Payload + 개인키 통해 Signature를 생성하므로 데이터위변조를 막을 수 있음 (무결성 보장)
- 인증정보에 대한 별도의 저장소가 필요없음
- Stateless 특징이 있어 서버의 확장성이 좋음 (시간지나면 알아서 만료되기 때문)

### 단점

- Payload를 탈취하여 디코딩하면 데이터를 볼 수 있기 때문에 중요한 정보를 담는건 지양해야함
- Stateless 특징이 있기 때문에 토큰이 만료되면 사용할수없음 (장점이자 단점)
